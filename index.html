<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è®¢å•ç®¡ç†ç³»ç»Ÿ v7.02 (æ ¸å¿ƒé€»è¾‘å¤–ç½®ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // --- ã€è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„Firebaseé…ç½®ã€‘ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBiu3oe1z388azShoVkqZm0IK14kBanlXI",
            authDomain: "ordersys-5d951.firebaseapp.com",
            projectId: "ordersys-5d951",
            storageBucket: "ordersys-5d951.firebasestorage.app",
            messagingSenderId: "99865299874",
            appId: "1:99865299874:web:e891e5dcf25e5d6ab5c0fb"
        };

        try {
            if (firebaseConfig.apiKey === "æ‚¨çš„apiKey") {
                console.warn("è¯·å…ˆé…ç½® Firebase ä¿¡æ¯ï¼");
                window.isFirebaseReady = false;
            } else {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                window.db = db;
                window.fb = { doc, getDoc, setDoc, updateDoc, onSnapshot, collection, getDocs, deleteDoc };
                window.isFirebaseReady = true;
            }
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±è´¥", e);
            window.isFirebaseReady = false;
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; padding-bottom: env(safe-area-inset-bottom); background-color: #f3f4f6; touch-action: manipulation; }
        .safe-bottom { padding-bottom: calc(64px + env(safe-area-inset-bottom)); }
        #app-header { position: sticky; top: 0; z-index: 50; }
        #app-content { position: relative; z-index: 1; padding-bottom: 80px; }
        #app-modal { position: fixed; inset: 0; z-index: 100; background-color: rgba(0,0,0,0.5); }
        #bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; max-width: 28rem; margin: 0 auto; background: white; }
        .btn-press:active { transform: scale(0.96); opacity: 0.8; }
        input, textarea, select { font-size: 16px !important; } 
        .compact-table th, .compact-table td { padding: 4px 2px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .login-bg { background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 1. é™æ€èµ„æº ---
        const ICON_PATHS={Calculator:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",Settings:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1-1-1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",Zap:"M13 2L3 14h9l-1 8 10-12h-9l1-8z",Trash2:"M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",Send:"M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z",Eraser:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21M22 21H7M5 11l9 9",ClipboardCheck:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2 M9 14l2 2 4-4",Scale:"m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z m-14 0 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z M7 21h10 M12 3v18 M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2",FileText:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8",Eye:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6",Check:"M20 6L9 17l-5-5",X:"M18 6L6 18M6 6l12 12",AlertTriangle:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z M12 9v4 M12 17h.01",ChevronDown:"m6 9 6 6 6-6",BookOpen:"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",ShieldAlert:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10 M12 8v4 M12 16h.01",User:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2",Copy:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2 M8 8h14v14H8z",Filter:"M22 3H2l8 9.46V19l4 2v-8.54L22 3z",RefreshCw:"M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15",Lock:"M12 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm5-9V7a5 5 0 0 0-10 0v1h-1v10h12V8h-1zm-6-1a4 4 0 1 1 8 0v1H11V7z",LogOut:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9",UserPlus:"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 11l2 2 4-4 M23 6v5h-5"};
        const Icon = ({ name, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{ICON_PATHS[name]&&<path d={ICON_PATHS[name]}/>}{!ICON_PATHS[name]&&<circle cx="12" cy="12" r="10" />}</svg>;

        const ZODIAC_LIST = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'];
        const ALL_NUMBERS = Array.from({length: 49}, (_, i) => i + 1);
        const WAVES = { 'RED': [1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46], 'BLUE': [3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48], 'GREEN': [5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49] };
        const isOdd = n => n % 2 !== 0; const isEven = n => n % 2 === 0;
        const isSmall = n => n >= 1 && n <= 24; const isBig = n => n >= 25 && n <= 49; 
        const getSumDigit = n => Math.floor(n / 10) + (n % 10);
        
        const KEYWORDS = (() => {
            const k = {};
            const odds=ALL_NUMBERS.filter(isOdd), evens=ALL_NUMBERS.filter(isEven);
            k['å•æ•°']=odds; k['å•']=odds; k['åŒæ•°']=evens; k['åŒ']=evens;
            k['å°å•']=ALL_NUMBERS.filter(n=>isSmall(n)&&isOdd(n)); k['å°åŒ']=ALL_NUMBERS.filter(n=>isSmall(n)&&isEven(n));
            k['å¤§å•']=ALL_NUMBERS.filter(n=>isBig(n)&&isOdd(n)); k['å¤§åŒ']=ALL_NUMBERS.filter(n=>isBig(n)&&isEven(n));
            k['åˆæ•°å•']=ALL_NUMBERS.filter(n=>getSumDigit(n)%2!==0); k['åˆå•']=ALL_NUMBERS.filter(n=>getSumDigit(n)%2!==0);
            k['åˆæ•°åŒ']=ALL_NUMBERS.filter(n=>getSumDigit(n)%2===0); k['åˆåŒ']=ALL_NUMBERS.filter(n=>getSumDigit(n)%2===0);
            k['çº¢æ³¢']=WAVES.RED; k['çº¢']=WAVES.RED; k['è“æ³¢']=WAVES.BLUE; k['è“']=WAVES.BLUE; k['ç»¿æ³¢']=WAVES.GREEN; k['ç»¿']=WAVES.GREEN;
            const rO=WAVES.RED.filter(isOdd), rE=WAVES.RED.filter(isEven); const bO=WAVES.BLUE.filter(isOdd), bE=WAVES.BLUE.filter(isEven); const gO=WAVES.GREEN.filter(isOdd), gE=WAVES.GREEN.filter(isEven);
            k['çº¢å•']=rO; k['çº¢æ³¢å•']=rO; k['çº¢åŒ']=rE; k['çº¢æ³¢åŒ']=rE; k['è“å•']=bO; k['è“æ³¢å•']=bO; k['è“åŒ']=bE; k['è“æ³¢åŒ']=bE; k['ç»¿å•']=gO; k['ç»¿æ³¢å•']=gO; k['ç»¿åŒ']=gE; k['ç»¿æ³¢åŒ']=gE;
            k['çº¢ç»¿å•']=[...rO, ...gO]; k['çº¢ç»¿åŒ']=[...rE, ...gE]; k['çº¢è“å•']=[...rO, ...bO]; k['çº¢è“åŒ']=[...rE, ...bE]; k['è“ç»¿å•']=[...bO, ...gO]; k['è“ç»¿åŒ']=[...bE, ...gE];
            return k;
        })();

        const PATTERN_HK = "é¦™æ¸¯|é¦™|æ¸¯"; const PATTERN_MO = "æ¾³é—¨|æ¾³|é—¨|å¥¥|æ–°æ¾³é—¨|è€æ¾³é—¨|å™¢T|æº´T"; 
        const REGEX_DUAL = new RegExp("([é¦™æ¸¯][\\s.,ï¼Œ;ï¼›]*[æ¾³é—¨å¥¥])|([æ¾³é—¨å¥¥][\\s.,ï¼Œ;ï¼›]*[é¦™æ¸¯])");
        const CH_NUM = "é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸¤"; const UNITS = "å…ƒç±³æ–¤å—";
        const BASE_AMOUNT_PARTS = [`((æ¯ä¸ªå·å„|æ¯ä¸ªå·|æ¯å·å„|æ¯ä¸ª|æ¯å·|ä¸ªå·|ä¸ª|å„|ä¹°|x|X|å·|=|æ¯)[\\s.ï¼ã€‚â€¦~ï¼‡']*\\d+(\\.\\d+)?[\\s.ï¼ã€‚â€¦~ï¼‡']*[${UNITS}]?)`, `(\\d+(\\.\\d+)?[\\s.ï¼ã€‚â€¦~ï¼‡']*[${UNITS}])`, `(\\d+(\\.\\d+)?x)`, `((æ¯ä¸ª|æ¯å·|ä¸ªå·|ä¸ª|å„|ä¹°|x|X|å·|=|æ¯)[\\s.ï¼ã€‚â€¦~ï¼‡']*[${CH_NUM}]+[\\s.ï¼ã€‚â€¦~ï¼‡']*[${UNITS}]?)`, `([${CH_NUM}]+[\\s.ï¼ã€‚â€¦~ï¼‡']*[${UNITS}])`, `((?<=[\\d\\s])[${CH_NUM}]+(?!([å²å°¾å¤´])))`, `(?<=[å·])\\d+(\\.\\d+)?`].join("|");
        const REGEX_AMOUNT_NO_SLASH = new RegExp(BASE_AMOUNT_PARTS, 'gi');
        const REGEX_AMOUNT_WITH_SLASH = new RegExp(`${BASE_AMOUNT_PARTS}|(\\/[\\s.ï¼ã€‚â€¦~ï¼‡']*\\d+(\\.\\d+)?\\s*[${UNITS}]?)`, 'gi');
        const REGEX_CHAT_HEADER = /^.*[:ï¼š]\s*$/;
        const REGEX_CLIENT_TOTAL = /(?:[ï¼Œ,ã€‚;ï¼›]\s*)?(?:[ï¼ˆ(]\s*)?(?:åˆè®¡|æ€»è®¡|ä¸€å…±|æ‰“åŒ…)\s*[:ï¼š]?\s*\d+(?:\.\d+)?(?:\s*[å…ƒ])?(?:\s*[)ï¼‰])?/gi;

        const parseChineseNumber = (s) => { const map={'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸¤':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'ç™¾':100,'åƒ':1000}; if(s.length===1 && map[s]!==undefined && map[s]<10) return map[s]; let res=0, curr=0; for(let i=0;i<s.length;i++){ const val=map[s[i]]; if(val>=10){ if(curr===0)curr=1; res+=curr*val; curr=0; } else if(val!==undefined) curr=val; } return (res+curr)||NaN; };
        const smartMergeLines = (lines) => { const merged=[]; let pending=""; const hasAmount=(s)=> /((æ¯ä¸ª|æ¯å·|ä¸ªå·|ä¸ª|å„|ä¹°|x|X|å·|=|æ¯)[\s.ï¼ã€‚â€¦~ï¼‡']*[\dé›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+)|(\d+[\s.ï¼ã€‚â€¦~ï¼‡']*[å…ƒç±³æ–¤å—])|(\d+[\s.ï¼ã€‚â€¦~ï¼‡']*x)/.test(s); lines.forEach(line => { const clean = line.trim(); if (!clean) return; if (REGEX_CHAT_HEADER.test(clean)) { if (pending) { merged.push(pending); pending=""; } merged.push(clean); return; } if (hasAmount(clean)) { merged.push(pending + (/^[å²å°¾å¤´]/.test(clean)?"":" ") + clean); pending=""; } else if (/\d|([é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒªçº¢è“ç»¿æ³¢å•åŒ])/.test(clean)) pending += (pending&&!/^[å²å°¾å¤´]/.test(clean)?" ":"") + clean; else { if (pending) { merged.push(pending); pending=""; } merged.push(clean); } }); if (pending) merged.push(pending); return merged; };
        const getNumbersForZodiac = (z, currentYear) => { const idx=ZODIAC_LIST.indexOf(currentYear), tIdx=ZODIAC_LIST.indexOf(z); if(idx===-1||tIdx===-1) return []; const offset=(idx-tIdx+12)%12; return Array.from({length:5},(_,i)=>offset+1+i*12).filter(n=>n<=49); };

        // --- æ ¸å¿ƒè§£æé€»è¾‘ (å¤–ç½®) ---
        // å…³é”®ä¿®å¤ï¼šå°†è¿™äº›å‡½æ•°ç§»å‡º App ç»„ä»¶ï¼Œé¿å… ReferenceError å’Œæ­»å¾ªç¯
        const parseContentWithoutAmount = (text, defaultType, currentYearZodiac) => {
            let nums=[], count=0, type=defaultType, txt=text.toUpperCase();
            if (new RegExp(PATTERN_HK).test(text)) type='HK'; else if (new RegExp(PATTERN_MO).test(text)) type='MO';
            txt = txt.replace(new RegExp(PATTERN_HK,'g'),' ').replace(new RegExp(PATTERN_MO,'g'),' ').replace(REGEX_DUAL,' ').replace(/å…/g,'å…”').replace(/(ä¸ªå·|ä¸ª)/g,' å„ ').replace(/[Tt]/g,' ').replace(/(æ¯ä¸ª|æ¯|ä¸€å…±|æ€»è®¡)/g,' å„ ').replace(/å·/g,' ').replace(/å²æ•°/g,'å²').replace(/(\d+)\s*[.,ï¼Œ;ï¼›*]+\s*(å²|å°¾|å¤´)/g,'$1$2').replace(/(\d(å²|å°¾|å¤´))\s*(\/)\s*(\d)/g,'$1 $4').replace(/([å²å°¾å¤´])(\d)/g,'$1 $2');
            txt = txt.replace(/(\d+)[.ï¼ã€‚â€¦~ï¼‡' -]*\s*åˆ°\s*[.ï¼ã€‚â€¦~ï¼‡' -]*(\d+)/g, (m,s,e) => { const n1=parseInt(s),n2=parseInt(e); return (n1<n2&&n2-n1<49) ? Array.from({length:n2-n1+1},(_,i)=>n1+i).join(' ') : m; });
            txt = txt.replace(new RegExp(`((?:\\d+[\\s.,ï¼Œ;ï¼›*\\/ã€‚ï¼â€¦~ï¼‡' -]+)+\\d+)[\\s.,ï¼Œ;ï¼›*\\/ã€‚ï¼â€¦~ï¼‡' -]*\\s*(å²|å°¾|å¤´)`, 'g'), (m,n,s)=>n.split(/[^\d]+/).filter(x=>x).map(x=>x+s).join(' '));
            txt = txt.replace(new RegExp(`([${ZODIAC_LIST.join('')}])`,'g'), ' $1 ').replace(/[.,ï¼Œ;ï¼›\/\-*\â€”â€“âˆ’+ã€‚ï¼š:â€¦~ï¼‡']/g, ' ').replace(/[*]/g, ' ');
            
            const hasSuspiciousTen = /([å°¾å¤´å²]|[é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª])\s*å|å\s*(\d+[å°¾å¤´å²]|[é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª])/.test(txt);
            let hasUnknown = false;
            txt.split(/\s+/).map(t=>t.replace(REGEX_AMOUNT_WITH_SLASH,'').trim()).filter(t=>t&&!t.includes('(XXF)')&&!t.match(/^\d{11}$/)).forEach(t => {
                const heMatch = t.match(/^åˆ(?:æ•°)?(\d+)$/); if(heMatch) { const v=parseInt(heMatch[1]); if(!isNaN(v)) for(let i=1;i<=49;i++) if(Math.floor(i/10)+(i%10)===v){nums.push(i);count++} return; }
                let n = parseInt(t);
                if (isNaN(n)) { const m = t.match(/^(\d+)/); if(m){ n=parseInt(m[1]); hasUnknown=true; } else if(!KEYWORDS[t]&&!ZODIAC_LIST.includes(t)&&!/^[å²å°¾å¤´]$/.test(t.slice(-1))) hasUnknown=true; }
                if (!isNaN(n) && n>=1 && n<=49 && !/^[å²å°¾å¤´]$/.test(t.slice(-1))) { nums.push(n); count++; return; }
                if (KEYWORDS[t]) { KEYWORDS[t].forEach(x=>nums.push(x)); count+=KEYWORDS[t].length; return; }
                if (ZODIAC_LIST.includes(t)) { getNumbersForZodiac(t, currentYearZodiac).forEach(x=>nums.push(x)); count+=getNumbersForZodiac(t, currentYearZodiac).length; return; }
                if (t.endsWith('å²')) { const a=parseInt(t); if(!isNaN(a)) for(let x=a;x<=49;x+=12) if(x>0){nums.push(x);count++} return; }
                if (t.endsWith('å°¾')||t.endsWith('å¤´')) { const v=parseInt(t); if(!isNaN(v)) { const isT=t.endsWith('å°¾'); for(let i=(isT?1:0);i<=49;i++) if(i>0 && (isT?i%10===v:Math.floor(i/10)===v)){nums.push(i);count++} } return; }
                if (!isNaN(n) && (n<1 || n>49)) hasUnknown=true;
            });
            return { numbers: nums.sort((a,b)=>a-b), totalBetCount: count, type, hasUnknown: hasUnknown||hasSuspiciousTen };
        };

        const parseContentForSegments = (text, defaultAmtStr, currentYearZodiac) => {
            let clientTotal = ''; const content = text.replace(REGEX_CLIENT_TOTAL, m => { clientTotal=m; return ''; }).trim();
            if (!content) return [];
            const segments=[], lines = smartMergeLines(content.split(/[\n]/).filter(l=>l.trim()));
            let currType = (new RegExp(PATTERN_HK).test(content) && !new RegExp(PATTERN_MO).test(content)) ? 'HK' : 'MO';

            lines.forEach(line => {
                if (REGEX_CHAT_HEADER.test(line)) return;
                if (new RegExp(`^(${PATTERN_HK}|${PATTERN_MO}|é¦™|æ¾³|é—¨|å¥¥|æ–°æ¾³é—¨|è€æ¾³é—¨)[:ï¼š]?$`).test(line.trim())) return;
                if (new RegExp(PATTERN_HK).test(line)) currType='HK'; else if (new RegExp(PATTERN_MO).test(line)) currType='MO'; else if (/å¥¥|é—¨/.test(line)) currType='MO';
                
                let processedLine = line.replace(/((?:æ¯ä¸ªå·å„|æ¯ä¸ªå·|æ¯å·å„|æ¯ä¸ª|æ¯å·|ä¸ªå·|ä¸ª|å„|ä¹°|x|X|å·|=|æ¯)\s*[\dé›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+(?:[\.]\d+)?[å…ƒç±³æ–¤å—]?)\s*[ï¼Œ,;ï¼›]\s*/g, '$1\n');
                processedLine = processedLine.replace(/(\d+(\.\d+)?\s*[/]\s*\d+(\.\d+)?)\s*[ï¼Œ,;ï¼›]\s*/g, '$1\n');
                let splitParts = processedLine.split(processedLine.includes('\n')?'\n':(processedLine.includes('å¦å¤–')?'å¦å¤–':/a^/));
                
                splitParts.forEach(subLine => {
                    if(!subLine.trim()) return;
                    const regex = /(å„|ä¹°|=|æ¯|å·)/.test(subLine) ? REGEX_AMOUNT_NO_SLASH : REGEX_AMOUNT_WITH_SLASH;
                    const matches = Array.from(subLine.matchAll(regex));
                    if (matches.length === 0) {
                        const res = parseContentWithoutAmount(subLine, currType, currentYearZodiac);
                        const isDual = REGEX_DUAL.test(subLine);
                        if (res.totalBetCount > 0 || res.hasUnknown || subLine.trim()) segments.push({ numbers:res.numbers, totalBetCount:res.totalBetCount, amount:parseFloat(defaultAmtStr)||0, content:subLine, type:res.type, isDualBet:isDual, isValid:res.totalBetCount>0&&(parseFloat(defaultAmtStr)>0), rawLine:subLine, isSuspicious:(res.totalBetCount>1&&!parseFloat(defaultAmtStr)&&!/[å…ƒç±³æ–¤å—]/.test(subLine))||res.hasUnknown, fullLine:line });
                    } else {
                        let cursor=0;
                        matches.forEach(m => {
                            const amtTxt=m[0], idx=m.index, content=subLine.substring(cursor, idx).trim().replace(/^[.,ï¼Œ;ï¼›ã€\/\-*\â€”â€“âˆ’ã€‚ï¼š:+â€¦~ï¼‡']+/g, '');
                            let amt=0, numM=amtTxt.match(/(\d+(\.\d+)?)/); if(numM) amt=parseFloat(numM[0]); else { const chM=amtTxt.match(new RegExp(`[${CH_NUM}]+`)); if(chM) amt=parseChineseNumber(chM[0]); }
                            if(content){ 
                                const res=parseContentWithoutAmount(content, currType, currentYearZodiac); 
                                const isDual = REGEX_DUAL.test(content);
                                if(res.totalBetCount>0 || res.hasUnknown) segments.push({ numbers:res.numbers, totalBetCount:res.totalBetCount, amount:amt, content, type:res.type, isDualBet:isDual, isValid:amt>0 && res.totalBetCount>0, rawLine:content+amtTxt, isSuspicious:(res.totalBetCount>1&&!/[å„xX\/å…ƒç±³æ–¤å—=æ¯å·ä¸ª]/.test(amtTxt))||res.hasUnknown, fullLine:line }); 
                            }
                            cursor=idx+amtTxt.length;
                        });
                        const trail = subLine.substring(cursor).trim().replace(/^[.,ï¼Œ;ï¼›ã€\/\-*\â€”â€“âˆ’ã€‚ï¼š:+â€¦~ï¼‡']+/g, '');
                        if(trail){ 
                            const res=parseContentWithoutAmount(trail, currType, currentYearZodiac); 
                            const isDual = REGEX_DUAL.test(trail);
                            if(res.totalBetCount>0 || res.hasUnknown) segments.push({ numbers:res.numbers, totalBetCount:res.totalBetCount, amount:parseFloat(defaultAmtStr)||0, content:trail, type:res.type, isDualBet:isDual, isValid:res.totalBetCount>0&&(parseFloat(defaultAmtStr)>0), rawLine:trail, isSuspicious:!parseFloat(defaultAmtStr)||res.hasUnknown, fullLine:line }); 
                        }
                    }
                });
            });
            if(segments.length>0) { if(clientTotal) segments[0].clientTotal=clientTotal; if(content) segments[0].fullText=content; }
            return segments;
        };

        // --- æ¨¡æ€æ¡†å®¹å™¨ ---
        const ModalContainer = ({ children }) => ( <div id="app-modal" className="flex items-center justify-center p-4 animate-fade-in">{children}</div> );

        const ActionSheet = ({ title, actions, onCancel }) => !actions ? null : ( <ModalContainer> <div className="bg-white w-full max-w-sm rounded-xl p-4 space-y-3 shadow-2xl mt-auto sm:mt-0"> {title && <div className="text-center font-bold text-gray-500 pb-2 border-b text-sm">{title}</div>} {actions.map((a, i) => <button key={i} onClick={a.onClick} className={`w-full py-3.5 rounded-lg font-bold text-center text-lg btn-press ${a.className||'bg-gray-100 text-gray-800'}`}>{a.text}</button>)} <button onClick={onCancel} className="w-full py-3 rounded-lg font-bold text-center text-gray-500 border bg-white mt-2 btn-press">å–æ¶ˆ</button> </div> </ModalContainer> );
        const ConfirmationModal = ({ confirmation }) => !confirmation ? null : ( <ModalContainer> <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4"> <div className="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center"><Icon name="AlertTriangle" className="w-6 h-6 text-red-600"/></div> <p className="text-center font-bold text-lg text-slate-800 whitespace-pre-line">{confirmation.message}</p> <div className="flex gap-3 pt-2"> <button onClick={confirmation.onCancel} className="flex-1 py-2 rounded border hover:bg-slate-100 btn-press">å–æ¶ˆ</button> <button onClick={confirmation.onConfirm} className="flex-1 py-2 rounded bg-red-600 text-white hover:bg-red-700 btn-press">ç¡®è®¤</button> </div> </div> </ModalContainer> );
        const CustomerSelectModal = ({ customers, onSelect, onClose }) => ( <ModalContainer> <div className="bg-white w-full max-w-sm rounded-xl p-4 max-h-[80vh] flex flex-col shadow-2xl"> <div className="flex justify-between items-center mb-4 border-b pb-2"> <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icon name="User" className="w-5 h-5 text-indigo-600"/> é€‰æ‹©å®¢æˆ·</h3> <button onClick={onClose} className="p-2 btn-press"><Icon name="X" className="w-6 h-6 text-slate-500"/></button> </div> <div className="flex-1 overflow-y-auto space-y-2"> {customers.map(c => <button key={c.id} onClick={()=>onSelect(c.name)} className="w-full text-left p-3 rounded-lg hover:bg-indigo-50 border border-slate-100 font-bold text-slate-700 flex items-center justify-between active:bg-indigo-100 transition-colors btn-press"><span>{c.name}</span><span className="text-xs text-slate-400 font-normal">èµ”{c.odds} / é€€{c.rebate*100}%</span></button>)} </div> <button onClick={onClose} className="mt-4 w-full py-3 border rounded-lg text-slate-500 font-medium btn-press">å–æ¶ˆ</button> </div> </ModalContainer> );
        const MobileRiskTable = ({title,color,data,total}) => ( <div className="bg-white rounded shadow border border-slate-200 flex flex-col h-full overflow-hidden"> <div className={`p-2 text-center font-bold text-xs ${color==='red'?'bg-red-50 text-red-700':'bg-green-50 text-green-700'}`}>{title} (Â¥{total.toLocaleString()})</div> <div className="flex-1 overflow-y-auto"> <table className="w-full text-xs text-center"> <thead className="bg-slate-50 text-slate-400"><tr><th className="py-1">å·</th><th>æ³¨</th><th>äº</th></tr></thead> <tbody>{data.map(d=><tr key={d.num} className={`border-b last:border-0 ${d.customerPL>0?'bg-red-50':''}`}><td className="py-2 font-bold">{d.num}</td><td className="text-slate-500">{d.betAmt>0?d.betAmt:'-'}</td><td className={d.customerPL>0?'text-red-600 font-bold':'text-green-600'}>{Math.round(d.customerPL)}</td></tr>)}</tbody> </table> </div> </div> );
        
        const EditOrderModal = ({ batchId, onClose, onSave, bets, currentYearZodiac }) => { 
            const recs = bets.filter(b=>b.batchId===batchId); 
            const [lines, setLines] = useState(Array.from(new Set(recs.map(r=>r.rawInput))).filter(l=>l)); 
            const header = recs[0]?.originalHeader; 
            const originalDisplay = recs[0]?.fullText || lines.join('\n'); 
            const stats = lines.map(l => { 
                const segs = parseContentForSegments(l, '0', currentYearZodiac); 
                const valid = segs.length>0 && segs.every(s=>s.isValid && !s.isSuspicious); 
                return { valid: valid && !segs.some(s=>s.hasUnknown), amt: segs.reduce((a,b)=>a + b.totalBetCount*b.amount*(b.isDualBet?2:1), 0) }; 
            }); 
            // ... render logic omitted for brevity ...
            return ( <ModalContainer> <div className="bg-white w-full h-[80vh] rounded-xl flex flex-col overflow-hidden"> <div className="p-4 border-b flex justify-between items-center bg-slate-50"><div className="font-bold text-lg">è®¢å•æ ¡å¯¹ <div className="text-xs font-normal text-slate-500 mt-1">{header}</div></div><div className="text-indigo-600 font-bold text-xl">Â¥{stats.reduce((a,b)=>a+b.amt,0)}</div></div> <div className="flex-1 overflow-y-auto p-4 space-y-4"> <div className="bg-yellow-50 p-3 rounded text-xs text-slate-600 border border-yellow-100"><strong className="block mb-1">åŸå§‹è®°å½•:</strong><pre className="whitespace-pre-wrap font-mono break-all">{originalDisplay}</pre>{recs[0]?.originalTotal && <div className="mt-1 text-orange-600 font-bold">å®¢æˆ·æ‰‹å†™: {recs[0].originalTotal}</div>}</div> {lines.map((l,i)=><div key={i} className="space-y-1"><div className={`flex gap-2 p-2 rounded border ${!stats[i].valid?'border-red-300 bg-red-50':'border-slate-200'}`}><span className="text-slate-400 w-4 pt-2 text-xs">{i+1}</span><textarea value={l} onChange={e=>{const n=[...lines];n[i]=e.target.value;setLines(n)}} className="flex-1 bg-transparent outline-none text-sm resize-none h-auto overflow-hidden break-all" rows={1} style={{minHeight:'24px'}}/><div className="text-right"><div className="text-xs text-slate-400 font-bold">Â¥{stats[i].amt}</div><button onClick={()=>{const n=[...lines];n.splice(i,1);setLines(n)}} className="text-red-400 mt-1"><Icon name="X" className="w-4 h-4"/></button></div></div></div>)} <button onClick={()=>setLines([...lines,''])} className="w-full py-3 border-2 border-dashed rounded text-slate-400 font-bold btn-press">+ æ·»åŠ è¡Œ</button> </div> <div className="p-4 border-t flex gap-3"><button onClick={onClose} className="flex-1 py-3 border rounded-lg font-bold btn-press">å–æ¶ˆ</button><button onClick={()=>onSave(batchId, lines.filter(x=>x.trim()))} className="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold shadow btn-press">ä¿å­˜ä¿®æ”¹</button></div> </div> </ModalContainer> ); 
        };
        const RawRecordModal = ({ batch, onClose }) => ( <ModalContainer> <div className="bg-white w-full max-w-md rounded-xl p-6 shadow-2xl"> <h3 className="font-bold text-lg mb-4 border-b pb-2">åŸå§‹ä¸‹å•è®°å½•</h3> <div className="bg-slate-100 p-4 rounded-lg text-sm font-mono whitespace-pre-wrap max-h-[60vh] overflow-y-auto text-slate-700"> <div className="font-bold mb-2 text-slate-900">{batch.header}</div> {batch.originalTotal && <div className="text-orange-600 font-bold mb-2">æ‰‹å†™æ€»è®¡: {batch.originalTotal}</div>} <pre className="whitespace-pre-wrap break-all">{batch.fullText || batch.lines.join('\n')}</pre> </div> <button onClick={onClose} className="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow btn-press">å…³é—­</button> </div> </ModalContainer> );
        const HedgingModal = ({ onClose, riskStats, riskFilter, customers, bets, showAlert }) => { const [activeType, setActiveType] = useState(riskFilter==='HK'?'HK':'MO'); const [hedgingTarget, setHedgingTarget] = useState('ALL'); const [maxLossLimit, setMaxLossLimit] = useState('0'); const [maxBetLimit, setMaxBetLimit] = useState('500'); const [copyMsg, setCopyMsg] = useState(''); const [transferHistory, setTransferHistory] = useState({}); const activeCustomers = useMemo(() => Array.from(new Set(bets.map(b => b.customerName))).sort(), [bets]); useEffect(() => setTransferHistory({}), [activeType]); const currentRiskStats = useMemo(() => { let filtered = bets.filter(b => !b.isError); if (hedgingTarget !== 'ALL') filtered = filtered.filter(b => b.customerName === hedgingTarget); const stats = { hk:Array.from({length:49},(_,i)=>({num:i+1,betAmt:0,payout:0})), mo:Array.from({length:49},(_,i)=>({num:i+1,betAmt:0,payout:0})) }; let [hkP,hkR,moP,moR] = [0,0,0,0]; filtered.forEach(b => { const c = customers.find(cust=>cust.name===b.customerName)||{odds:47.5,rebate:0.1}; const reb = b.totalAmount*c.rebate; if(b.type==='HK'){hkP+=b.totalAmount;hkR+=reb}else{moP+=b.totalAmount;moR+=reb} b.numbers.forEach(n=>{if(n>=1&&n<=49){const t=b.type==='HK'?stats.hk[n-1]:stats.mo[n-1]; t.betAmt+=b.amountPerNumber; t.payout+=b.amountPerNumber*c.odds;}}); }); const calc = (l,pool,reb)=>l.map(i=>({...i, customerPL:(i.payout+reb)-pool})).sort((a,b)=>b.betAmt-a.betAmt); return { hk:calc(stats.hk,hkP,hkR), mo:calc(stats.mo,moP,moR), hkPool:hkP, hkRebate:hkR, moPool:moP, moRebate:moR }; }, [bets, customers, hedgingTarget]); const data = activeType === 'HK' ? currentRiskStats.hk : currentRiskStats.mo; const maxWinForHouse = -Math.min(...data.map(d => d.customerPL)); const maxLossForHouse = Math.max(...data.map(d => d.customerPL)); useEffect(() => { if (maxLossLimit === '0' && maxWinForHouse > 0) setMaxLossLimit((maxWinForHouse * 0.9).toFixed(0)); }, [maxWinForHouse]); const processedData = useMemo(() => data.map(d => { let totalAdvice = 0; if (d.customerPL > parseFloat(maxLossLimit)) totalAdvice = Math.max(totalAdvice, (d.customerPL - parseFloat(maxLossLimit))/46.5); if (d.betAmt > parseFloat(maxBetLimit)) totalAdvice = Math.max(totalAdvice, d.betAmt - parseFloat(maxBetLimit)); return { ...d, totalAdvice: Math.round(totalAdvice), advice: Math.max(0, Math.round(totalAdvice) - (transferHistory[d.num] || 0)), alreadyTransferred: transferHistory[d.num] || 0 }; }), [data, maxLossLimit, maxBetLimit, transferHistory]); const copyAndMarkTransferred = () => { const lines = processedData.filter(d => d.advice > 0).map(d => `${d.num}=${d.advice}`); if (lines.length === 0) { showAlert("æ— æ–°å¢é£é™©å•", "warning"); return; } const el = document.createElement('textarea'); el.value = lines.join(' '); document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); const newHistory = { ...transferHistory }; processedData.forEach(d => { if (d.advice > 0) newHistory[d.num] = (newHistory[d.num] || 0) + d.advice; }); setTransferHistory(newHistory); setCopyMsg('å·²ç´¯åŠ æ ‡è®°!'); setTimeout(()=>setCopyMsg(''), 2000); }; const displayData = processedData.map(d => ({ ...d, postTransferPL: d.customerPL - (d.totalAdvice * 47.5) + processedData.reduce((acc, x) => acc + x.totalAdvice, 0) })).sort((a,b) => b.betAmt - a.betAmt); const renderBankerPL = (v) => <span className={-v<0?'text-red-500':'text-green-600'}>{-v>0?'+':''}{Math.round(-v)}</span>; return ( <ModalContainer> <div className="bg-white z-[5000] flex flex-col w-full h-[100dvh]"> <div className="p-3 bg-slate-100 border-b flex justify-between items-center shrink-0"><h3 className="font-bold flex items-center gap-2 text-base"><Icon name="Scale" className="w-5 h-5"/> æ™ºèƒ½è½¬å• (ç´¯åŠ ç‰ˆ)</h3><button onClick={onClose} className="btn-press"><Icon name="X" className="w-6 h-6 text-slate-500"/></button></div> <div className="bg-blue-50 p-2 text-xs grid grid-cols-2 gap-x-4 border-b border-blue-100 shrink-0"> <div><div className="flex justify-between"><span>æœ€é«˜å¯èµ¢:</span><span className="text-green-600 font-bold">+Â¥{Math.round(maxWinForHouse).toLocaleString()}</span></div><div className="flex justify-between mt-1 border-t border-blue-100 pt-1"><span className="text-purple-500">è½¬åå¯èµ¢:</span><span className="text-purple-700 font-bold">+Â¥{Math.round(-Math.min(...displayData.map(d=>d.postTransferPL))).toLocaleString()}</span></div></div> <div><div className="flex justify-between"><span>æœ€å¤§é£é™©:</span><span className="text-red-600 font-bold">Â¥{Math.round(maxLossForHouse).toLocaleString()}</span></div><div className="flex justify-between mt-1 border-t border-blue-100 pt-1"><span className="text-orange-500">è½¬åé£é™©:</span><span className="text-orange-600 font-bold">Â¥{Math.round(Math.max(...displayData.map(d=>d.postTransferPL))).toLocaleString()}</span></div></div> </div> <div className="p-2 space-y-2 border-b bg-white shrink-0 text-sm"> <div className="flex gap-2 items-center"><div className="flex-1"><select className="w-full border rounded px-2 py-1.5 bg-white text-xs font-bold" value={hedgingTarget} onChange={e=>setHedgingTarget(e.target.value)}><option value="ALL">å…¨éƒ¨è®¢å•</option><optgroup label="ä¸‹æ³¨å®¢æˆ·">{activeCustomers.map(n=><option key={n} value={n}>{n}</option>)}</optgroup></select></div><div className="flex border rounded overflow-hidden shrink-0 text-xs"><button onClick={()=>setActiveType('MO')} className={`px-2 py-1.5 ${activeType==='MO'?'bg-green-500 text-white':'bg-slate-100'}`}>æ¾³é—¨</button><button onClick={()=>setActiveType('HK')} className={`px-2 py-1.5 ${activeType==='HK'?'bg-red-500 text-white':'bg-slate-100'}`}>é¦™æ¸¯</button></div></div> <div className="flex gap-2 items-center bg-slate-50 p-1.5 rounded"><div className="flex-1 flex items-center gap-1"><span className="text-xs whitespace-nowrap">å»ºè®®æ­¢æŸ:</span><input type="number" value={maxLossLimit} onChange={e=>setMaxLossLimit(e.target.value)} className="w-full border-b bg-transparent text-center font-bold text-red-600 text-sm"/></div><div className="w-px h-4 bg-slate-300"></div><div className="flex-1 flex items-center gap-1"><span className="text-xs whitespace-nowrap">æœ€å¤§åƒç :</span><input type="number" value={maxBetLimit} onChange={e=>setMaxBetLimit(e.target.value)} className="w-full border-b bg-transparent text-center font-bold text-indigo-600 text-sm"/></div></div> </div> <div className="bg-orange-50 px-3 py-2 text-xs flex justify-between items-center border-b border-orange-100 text-orange-800 font-bold"><span>æœ¬æ¬¡: Â¥{processedData.reduce((a,d)=>a+d.advice,0)}</span><span>å·²è½¬: Â¥{Object.values(transferHistory).reduce((a,b)=>a+b,0)}</span></div> <div className="flex-1 overflow-y-auto p-0 bg-slate-50"> <table className="w-full text-xs text-center border-collapse compact-table"><thead className="bg-slate-200 sticky top-0 z-10"><tr><th className="w-8">å·</th><th>æœ¬æ¬¡</th><th>å·²è½¬</th><th>æ³¨</th><th>è½¬å</th></tr></thead> <tbody className="divide-y divide-slate-200 bg-white">{displayData.map(d=><tr key={d.num} className={d.advice>0?'bg-orange-50':''}><td className="font-bold border-r bg-slate-50">{d.num}</td><td className="text-orange-600 font-bold">{d.advice||'-'}</td><td className="text-slate-400">{d.alreadyTransferred||'-'}</td><td className="text-slate-400">{d.betAmt||'-'}</td><td className="font-bold">{renderBankerPL(d.postTransferPL)}</td></tr>)}</tbody> </table> </div> <div className="p-3 border-t bg-white shrink-0 safe-bottom-padding flex gap-2"><button onClick={()=>setTransferHistory({})} className="px-3 bg-slate-100 border rounded-xl btn-press"><Icon name="RefreshCw" className="w-5 h-5"/></button><button onClick={onClose} className="w-20 bg-slate-100 border rounded-xl font-bold btn-press">å…³é—­</button><button onClick={copyAndMarkTransferred} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow flex items-center justify-center gap-2 btn-press"><Icon name="ClipboardCheck" className="w-5 h-5"/> {copyMsg||`å¤åˆ¶ (${processedData.filter(d=>d.advice>0).length})`}</button></div> </div> </ModalContainer> ); };

        // --- Admin & Login Panels (ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èšç„¦æ ¸å¿ƒä¿®å¤) ---
        const AdminPanel = ({ onClose, db }) => { const [code, setCode] = useState(''); const [days, setDays] = useState(30); const [codes, setCodes] = useState([]); const fetchCodes = async () => { if(!db || !window.fb) return; try { const snap = await window.fb.getDocs(window.fb.collection(db, "access_codes")); setCodes(snap.docs.map(d => ({id: d.id, ...d.data()}))); } catch(e) { alert("è·å–æ•°æ®å¤±è´¥: " + e.message); } }; useEffect(() => { fetchCodes(); }, []); const handleCreate = async () => { if(!code) return; if(!db || !window.fb) { alert("æ•°æ®åº“æœªè¿æ¥"); return; } const expiry = new Date(); expiry.setDate(expiry.getDate() + parseInt(days)); await window.fb.setDoc(window.fb.doc(db, "access_codes", code), { isActive: true, expiresAt: expiry.getTime(), bets: [], customers: [] }); alert("è®¿é—®ç  " + code + " åˆ›å»ºæˆåŠŸï¼"); fetchCodes(); setCode(''); }; const handleDelete = async (id) => { if(confirm("ç¡®å®šåˆ é™¤ " + id + " å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) { await window.fb.deleteDoc(window.fb.doc(db, "access_codes", id)); fetchCodes(); } }; return ( <div className="fixed inset-0 bg-white z-[5000] p-4 flex flex-col animate-fade-in"> <div className="flex justify-between items-center mb-4 border-b pb-2"> <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="Lock" className="w-6 h-6"/> ç®¡ç†å‘˜æ§åˆ¶å°</h2> <button onClick={onClose} className="p-2 btn-press"><Icon name="X" className="w-6 h-6"/></button> </div> <div className="mb-6 p-4 bg-indigo-50 rounded-xl space-y-4 shadow-sm border border-indigo-100"> <h3 className="font-bold text-indigo-900 flex items-center gap-2"><Icon name="UserPlus" className="w-5 h-5"/> ç”Ÿæˆæ–°è®¿é—®ç </h3> <div className="flex gap-2"> <input value={code} onChange={e=>setCode(e.target.value)} placeholder="è®¾ç½®ç”¨æˆ·å¯†ç  (å¦‚: 8888)" className="border p-3 rounded-lg flex-1 outline-none focus:ring-2 focus:ring-indigo-500"/> <select value={days} onChange={e=>setDays(e.target.value)} className="border p-3 rounded-lg bg-white outline-none"> <option value="1">1å¤©</option> <option value="7">7å¤©</option> <option value="30">30å¤©</option> <option value="365">1å¹´</option> </select> </div> <button onClick={handleCreate} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-md btn-press">åˆ›å»ºç”¨æˆ·è´¦å·</button> </div> <div className="flex-1 overflow-y-auto"> <h3 className="font-bold mb-3 text-gray-700 px-1">å·²å­˜åœ¨çš„ç”¨æˆ·åˆ—è¡¨</h3> {codes.map(c => ( <div key={c.id} className="flex justify-between items-center p-4 border-b bg-white hover:bg-gray-50 transition-colors"> <div> <div className="font-bold text-lg text-gray-800">{c.id}</div> <div className="text-xs text-gray-400 mt-1">æœ‰æ•ˆæœŸè‡³: {new Date(c.expiresAt).toLocaleDateString()}</div> </div> <button onClick={()=>handleDelete(c.id)} className="text-red-500 bg-red-50 p-2 rounded-lg btn-press"><Icon name="Trash2" className="w-5 h-5"/></button> </div> ))} </div> </div> ); };
        const LoginScreen = ({ onLogin, onAdmin }) => { const [code, setCode] = useState(''); const [loading, setLoading] = useState(false); const handleLogin = async () => { if(!code) return; if(code === 'admin888') { onAdmin(); return; } if (!window.isFirebaseReady) { alert("è¯·å…ˆé…ç½®ä»£ç ä¸­çš„ Firebase ä¿¡æ¯ï¼"); return; } setLoading(true); try { const docRef = window.fb.doc(window.db, "access_codes", code); const docSnap = await window.fb.getDoc(docRef); if (docSnap.exists()) { const data = docSnap.data(); if (Date.now() > data.expiresAt) { alert("æ­¤è®¿é—®ç å·²è¿‡æœŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜ç»­è´¹ã€‚"); } else { onLogin(code, data); } } else { alert("è®¿é—®ç ä¸å­˜åœ¨ï¼Œè¯·é‡è¯•ï¼"); } } catch(e) { console.error(e); alert("ç™»å½•å‡ºé”™: " + e.message); } setLoading(false); }; return ( <div className="min-h-screen login-bg flex items-center justify-center p-4"> <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 space-y-6 animate-fade-in"> <div className="text-center"> <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner"> <Icon name="Zap" className="w-8 h-8"/> </div> <h1 className="text-2xl font-bold text-gray-800">ç³»ç»Ÿç™»å½•</h1> <p className="text-gray-400 text-sm mt-2">è¯·è¾“å…¥ç®¡ç†å‘˜æä¾›çš„è®¿é—®ç </p> </div> <div className="space-y-4"> <input type="text" value={code} onChange={e=>setCode(e.target.value)} className="w-full text-center text-2xl font-bold border-2 border-gray-100 rounded-xl focus:border-indigo-500 outline-none py-4 tracking-widest bg-gray-50 focus:bg-white transition-all text-indigo-900" placeholder="è¾“å…¥è®¿é—®ç " /> <button onClick={handleLogin} disabled={loading} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all btn-press disabled:opacity-50 disabled:cursor-not-allowed"> {loading ? "æ­£åœ¨éªŒè¯..." : "è¿›å…¥ç³»ç»Ÿ"} </button> </div> <div className="text-center text-xs text-gray-300 pt-4">v7.02 äº‘ç«¯äº’è¸¢ç‰ˆ</div> </div> </div> ); };

        function App() {
            const [userCode, setUserCode] = useState(localStorage.getItem('lottery_user_code') || null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [sessionID, setSessionID] = useState(localStorage.getItem('lottery_session_id') || null);
            
            const [bets, setBets] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [currentYearZodiac, setCurrentYearZodiac] = useState('è›‡');
            
            const [inputCustomer, setInputCustomer] = useState(''); const [inputContent, setInputContent] = useState(''); const [defaultAmount, setDefaultAmount] = useState('');
            const [activeTab, setActiveTab] = useState('input'); const [showSettings, setShowSettings] = useState(false); const [showCustomerModal, setShowCustomerModal] = useState(false);
            const [actionSheet, setActionSheet] = useState(null); const [tempCustomers, setTempCustomers] = useState([]); const [batchToEdit, setBatchToEdit] = useState(null);
            const [message, setMessage] = useState(null); const [confirmation, setConfirmation] = useState(null); const [showHedgingModal, setShowHedgingModal] = useState(false);
            const [textPreview, setTextPreview] = useState(null); const [winningNumberHK, setWinningNumberHK] = useState(''); const [winningNumberMO, setWinningNumberMO] = useState('');
            const [expandedReconciliation, setExpandedReconciliation] = useState(null); const [viewingRawBatch, setViewingRawBatch] = useState(null);
            const [previewBatches, setPreviewBatches] = useState([]); const [riskFilter, setRiskFilter] = useState('ALL'); const [bookMode, setBookMode] = useState('ALL'); const [bookTarget, setBookTarget] = useState('');

            // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (ç›´æ¥è°ƒç”¨å¤–ç½®å‡½æ•°) ---
            useEffect(() => {
                const txt = inputContent.trim();
                if (!txt) { setPreviewBatches([]); return; }
                const blocks=[]; let curHead='', curLines=[];
                txt.split('\n').forEach(l => { const isH=/[:ï¼š]\s*$/.test(l)&&!new RegExp(`^(${PATTERN_HK}|${PATTERN_MO})[:ï¼š]`).test(l); if(isH){if(curLines.length)blocks.push({header:curHead,text:curLines.join('\n')});curHead=l.trim();curLines=[];} else if(l.trim())curLines.push(l); });
                if(curLines.length) blocks.push({header:curHead,text:curLines.join('\n')});
                
                // ç›´æ¥è°ƒç”¨å¤–ç½®çš„è§£æå‡½æ•°
                const previews = blocks.map(b => {
                    const segments = parseContentForSegments(b.text, defaultAmount, currentYearZodiac).filter(s=>s.totalBetCount>0 || s.isSuspicious);
                    const systemTotal = segments.reduce((acc, seg) => acc + (seg.totalBetCount * (seg.isValid&&!seg.isSuspicious?seg.amount:0) * (seg.isDualBet?2:1)), 0);
                    let clientTotalVal = null; const m = segments[0]?.clientTotal?.match(/(\d+(\.\d+)?)/); if(m) clientTotalVal = parseFloat(m[0]);
                    return { header: b.header, segments, systemTotal, clientTotalStr: segments[0]?.clientTotal, mismatch: clientTotalVal !== null && Math.abs(clientTotalVal - systemTotal) > 0.5, clientTotalVal };
                }).filter(p => p.segments.length > 0);
                setPreviewBatches(previews);
            }, [inputContent, defaultAmount, currentYearZodiac]);

            const handleAddBet = (e) => {
                e.preventDefault(); if (!inputCustomer) return showAlert("è¯·å…ˆé€‰æ‹©å®¢æˆ·", "warning");
                const newBets = []; let total = 0;
                previewBatches.forEach((batch, idx) => {
                    const batchId = (Date.now() + idx).toString(36) + Math.random().toString(36).substr(2, 5);
                    batch.segments.forEach(seg => {
                        (seg.isDualBet ? ['HK', 'MO'] : [seg.type]).forEach(t => {
                            const amt = (seg.isValid && !seg.isSuspicious) ? seg.amount : 0;
                            newBets.push({ id:batchId+'-'+t+Math.random().toString(36), batchId, customerName:inputCustomer, type:t, numbers:seg.numbers, totalBetCount:seg.totalBetCount, amountPerNumber:seg.amount, totalAmount:seg.totalBetCount*amt, timestamp:Date.now()+idx, rawInput:seg.rawLine, formattedContent:seg.rawLine, originalHeader:batch.header, isError:!seg.isValid||seg.isSuspicious, originalTotal:seg.clientTotal||'', fullText:seg.fullText||'' });
                            total += seg.totalBetCount * amt;
                        });
                    });
                });
                setBets(p => [...p, ...newBets]); showAlert(`æˆåŠŸæäº¤ï¼å…± Â¥${total}`, 'success'); setInputContent(''); setActiveTab('customers');
            };

            const handleSaveEditedBatch = (batchId, lines) => {
                const oldBatch = bets.find(b=>b.batchId===batchId); if(!oldBatch) return;
                const newRecs = []; 
                // è°ƒç”¨å¤–ç½®å‡½æ•°
                const segments = parseContentForSegments(lines.join('\n'), '0', currentYearZodiac);
                segments.forEach(s => (s.isDualBet?['HK','MO']:[s.type]).forEach(t => newRecs.push({ id:batchId+Math.random(), batchId, customerName:oldBatch.customerName, type:t, numbers:s.numbers, totalBetCount:s.totalBetCount, amountPerNumber:s.amount, totalAmount:s.totalBetCount*(s.isValid&&!s.isSuspicious?s.amount:0), timestamp:oldBatch.timestamp, rawInput:s.rawLine, formattedContent:s.rawLine, originalHeader:oldBatch.originalHeader, isError:!s.isValid||s.isSuspicious, originalTotal:segments[0]?.clientTotal||'', fullText:oldBatch.fullText })));
                setBets(prev => [...prev.filter(b=>b.batchId!==batchId), ...newRecs]); setBatchToEdit(null); showAlert('ä¿®æ”¹ä¿å­˜æˆåŠŸ');
            };

            const handleLoginSuccess = async (code, initialData) => {
                const newSid = Math.random().toString(36).substring(2) + Date.now().toString(36);
                if (window.isFirebaseReady) {
                    await window.fb.updateDoc(window.fb.doc(window.db, "access_codes", code), { currentSessionId: newSid });
                }
                localStorage.setItem('lottery_user_code', code); localStorage.setItem('lottery_session_id', newSid);
                setUserCode(code); setSessionID(newSid);
                if(initialData) {
                    setBets(initialData.bets || []);
                    setCustomers(initialData.customers || []);
                    if(initialData.customers && initialData.customers.length > 0) setTempCustomers(initialData.customers);
                    else setTempCustomers([{id:'def_1',name:'å¼ ä¸‰',odds:47.5,rebate:0.02},{id:'def_2',name:'æå››',odds:47.5,rebate:0.03}]);
                }
            };
            const handleLogout = () => { localStorage.removeItem('lottery_user_code'); localStorage.removeItem('lottery_session_id'); setUserCode(null); setSessionID(null); setBets([]); setCustomers([]); };
            const handleClearClick = () => setActionSheet({ title: "æ•°æ®ç®¡ç†", actions: [ { text: inputCustomer?`ğŸ—‘ï¸ æ¸…ç©º [${inputCustomer}]`:"è¯·å…ˆé€‰æ‹©å®¢æˆ·", onClick:()=>{ if(inputCustomer){ setBets(p=>p.filter(b=>b.customerName!==inputCustomer)); showAlert(`å·²æ¸…ç©º ${inputCustomer}`, 'success'); setActionSheet(null); } } }, { text: "âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®", className: "bg-red-100 text-red-700", onClick:()=>{ setBets([]); showAlert('ç³»ç»Ÿå·²é‡ç½®', 'success'); setActionSheet(null); } } ], onCancel:()=>setActionSheet(null) });
            const handleDeleteBatchWithModal = (batchId) => setConfirmation({ message: "ç¡®å®šè¦åˆ é™¤æ­¤ç¬”è®¢å•å—ï¼Ÿ", onConfirm: () => { setBets(p => p.filter(b => b.batchId !== batchId)); setConfirmation(null); showAlert('å·²åˆ é™¤', 'success'); }, onCancel: () => setConfirmation(null) });
            const showAlert = (text, type='error') => { setMessage({text,type}); setTimeout(()=>setMessage(null),3000); };

            useEffect(() => { if (!userCode || !sessionID || !window.isFirebaseReady) return; const unsub = window.fb.onSnapshot(window.fb.doc(window.db, "access_codes", userCode), (doc) => { if (doc.exists()) { const data = doc.data(); if (data.currentSessionId && data.currentSessionId !== sessionID) { alert("æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œæ‚¨å·²è¢«å¼ºåˆ¶ä¸‹çº¿ï¼"); handleLogout(); } } else { alert("è´¦å·ä¸å­˜åœ¨ï¼"); handleLogout(); } }); return () => unsub(); }, [userCode, sessionID]);
            useEffect(() => { if (!userCode || !window.isFirebaseReady) return; const timer = setTimeout(() => { window.fb.updateDoc(window.fb.doc(window.db, "access_codes", userCode), { bets: bets, customers: customers }).catch(e => console.error(e)); }, 2000); return () => clearTimeout(timer); }, [bets, customers, userCode]);
            useEffect(() => { if(bets) localStorage.setItem('lottery_bets_v5', JSON.stringify(bets)) }, [bets]);
            useEffect(() => { if(currentYearZodiac) localStorage.setItem('lottery_year_zodiac', currentYearZodiac) }, [currentYearZodiac]);
            useEffect(() => { if(customers) localStorage.setItem('lottery_customers', JSON.stringify(customers)); }, [customers]);
            useEffect(() => { if(showSettings) setTempCustomers(customers || []); }, [showSettings, customers]);
            useEffect(() => { if (inputCustomer) { setBookTarget(inputCustomer); setBookMode('SINGLE'); } }, [inputCustomer]);

            if (!userCode && !isAdmin) return <LoginScreen onLogin={handleLoginSuccess} onAdmin={()=>setIsAdmin(true)} />;
            if (isAdmin) return <AdminPanel onClose={()=>setIsAdmin(false)} db={window.db}/>

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 flex flex-col">
                    <div id="app-header" className="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center">
                        <div className="flex items-center gap-2 font-bold text-lg"><Icon name="Zap" className="w-5 h-5 text-yellow-300"/> è®¢å•ç®¡ç†ç³»ç»Ÿ v7.02 ({userCode})</div>
                        <div className="flex gap-2">
                             <button onClick={()=>setShowSettings(true)} className="bg-white/20 px-2 py-1 rounded text-xs font-bold btn-press">å®¢æˆ·</button>
                             <button onClick={handleLogout} className="bg-red-500/80 px-2 py-1 rounded text-xs font-bold btn-press">é€€å‡º</button>
                        </div>
                    </div>
                    {message && <div className={`fixed top-20 left-4 right-4 p-3 rounded-lg shadow-xl text-white z-[9999] text-center ${message.type==='error'?'bg-red-500':'bg-green-500'} animate-fade-in`}>{message.text}</div>}
                    <div id="app-content" className="flex-1 p-4">
                         {activeTab === 'input' && (
                            <div className="flex flex-col h-full gap-4">
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-1 flex items-center justify-between sticky top-[72px] z-30">
                                    <div className="flex-1 px-3 py-2">
                                        <div className="text-xs text-slate-400 font-bold mb-0.5">å½“å‰å®¢æˆ·</div>
                                        <div className={`text-lg font-bold truncate ${inputCustomer ? 'text-indigo-600' : 'text-slate-300'}`}>{inputCustomer || "æœªé€‰æ‹©"}</div>
                                    </div>
                                    <button onClick={()=>setShowCustomerModal(true)} className="bg-indigo-50 text-indigo-600 px-4 py-3 rounded-xl font-bold text-sm btn-press flex items-center gap-1 border border-indigo-100 shadow-sm"><Icon name="User" className="w-4 h-4"/> åˆ‡æ¢/é€‰æ‹©</button>
                                </div>
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 flex-1 flex flex-col overflow-hidden relative z-10">
                                    <textarea value={inputContent} onChange={e=>setInputContent(e.target.value)} disabled={!inputCustomer} className={`w-full flex-1 p-4 resize-none outline-none text-base font-mono ${!inputCustomer ? 'bg-slate-50 cursor-not-allowed' : 'bg-white'}`} placeholder={!inputCustomer ? "è¯·å…ˆç‚¹å‡»å³ä¸Šæ–¹é€‰æ‹©å®¢æˆ·..." : "åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥æ³¨å•å†…å®¹..."}></textarea>
                                    {previewBatches.length > 0 && (
                                        <div className="bg-slate-50 border-t border-slate-100 max-h-40 overflow-y-auto p-2 text-xs">
                                            {previewBatches.map((b,i) => (
                                                <div key={i} className="mb-2 last:mb-0">
                                                    <div className="font-bold text-slate-400 px-1">{b.header}</div>
                                                    {b.mismatch && <div className="bg-red-50 border border-red-200 text-red-700 p-2 rounded mb-2 flex items-center gap-2 animate-fade-in font-bold"><Icon name="AlertTriangle" className="w-4 h-4 text-red-500"/><span>å®¢æˆ·æ ‡é¢ {b.clientTotalVal} â‰  ç³»ç»Ÿè®¡ç®— {b.systemTotal}</span></div>}
                                                    {b.segments.map((s,j) => (<div key={j} className={`p-1.5 rounded mb-1 flex justify-between items-center ${!s.isValid||s.isSuspicious ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-white border border-slate-200 text-slate-700'}`}><span className="break-all flex-1 mr-2">{s.rawLine} {s.hasUnknown && <span className="text-red-500 font-bold">(?)</span>}</span><span className="font-bold opacity-50">Â¥{s.amount*s.totalBetCount}</span></div>))}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="grid grid-cols-4 gap-2 z-20">
                                    <button onClick={()=>setInputContent('')} className="col-span-1 bg-white border border-slate-200 text-slate-500 rounded-xl py-3 flex items-center justify-center btn-press shadow-sm font-bold text-sm"><Icon name="Eraser" className="w-5 h-5"/></button>
                                    <button onClick={handleClearClick} className="col-span-1 bg-white border border-red-100 text-red-500 rounded-xl py-3 flex items-center justify-center btn-press shadow-sm font-bold text-sm"><Icon name="Trash2" className="w-5 h-5"/></button>
                                    <button onClick={handleAddBet} disabled={!inputCustomer} className={`col-span-2 rounded-xl py-3 flex items-center justify-center btn-press shadow-lg font-bold text-white text-lg gap-2 ${!inputCustomer ? 'bg-slate-300' : 'bg-indigo-600 shadow-indigo-200'}`}><Icon name="Send" className="w-5 h-5"/> æäº¤å½•å…¥</button>
                                </div>
                            </div>
                        )}
                        {/* ä¿æŒå…¶ä»– Tabs ä¸å˜ï¼Œåªåœ¨éœ€è¦ç”¨åˆ°è§£æå‡½æ•°çš„åœ°æ–¹ä¼ å…¥ currentYearZodiac */}
                        {activeTab === 'customers' && <div className="space-y-4"><div className="bg-white p-2 rounded-xl shadow-sm border border-indigo-50 sticky top-[72px] z-40 flex flex-col gap-2"><div className="flex justify-between items-center"><div className="flex bg-slate-100 rounded-lg p-1"><button onClick={()=>setBookMode('ALL')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${bookMode==='ALL'?'bg-white text-indigo-600 shadow-sm':'text-slate-500'}`}>å…¨éƒ¨</button><button onClick={()=>setBookMode('SINGLE')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${bookMode==='SINGLE'?'bg-white text-indigo-600 shadow-sm':'text-slate-500'}`}>æŒ‡å®š</button></div><div className="text-right"><div className="text-xs text-slate-400">åˆ—è¡¨æ€»é¢</div><div className="font-bold text-indigo-600">Â¥{displayedCustomerStats.reduce((a,c)=>a+c.total,0)}</div></div></div>{bookMode==='SINGLE' && <select value={bookTarget} onChange={e=>setBookTarget(e.target.value)} className="w-full bg-slate-50 border rounded-lg p-2 text-sm font-bold text-slate-700 outline-none">{customers.map(c=><option key={c.id} value={c.name}>{c.name}</option>)}</select>}</div>{displayedCustomerStats.map(cust => <details key={cust.name} open className="bg-white border rounded-xl shadow-sm overflow-hidden group"><summary className="flex justify-between items-center p-4 cursor-pointer bg-slate-50 group-open:bg-indigo-50 transition-colors"><div className="font-bold text-lg text-slate-800">{cust.name}</div><div className="font-bold text-indigo-600 text-xl">Â¥{cust.total}</div></summary><div className="p-3 space-y-3 bg-white border-t border-slate-100">{cust.batches.map((batch,i)=><div key={batch.batchId} className={`border rounded-lg p-3 ${batch.records.some(r=>r.isError)?'bg-red-50 border-red-200':'bg-slate-50/50 border-slate-200'}`}><div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-200/50"><span className="font-bold text-sm text-slate-600">#{i+1} ç¬”: Â¥{batch.total}</span><div className="flex gap-2"><button onClick={()=>setBatchToEdit(batch.batchId)} className="text-xs bg-white text-yellow-600 px-2.5 py-1 rounded-md border border-yellow-200 font-bold shadow-sm btn-press">æ”¹</button><button onClick={(e)=>{e.stopPropagation();handleDeleteBatchWithModal(batch.batchId)}} className="text-xs bg-white text-red-600 px-2.5 py-1 rounded-md border border-red-200 font-bold shadow-sm btn-press">åˆ </button></div></div><div className="text-xs font-mono text-slate-600 space-y-1">{batch.records.map((r,ri)=><div key={ri} className="flex justify-between border-b border-slate-100 last:border-0 pb-1 mb-1 items-start"><span className={`break-all flex-1 mr-2 ${r.isError?'text-red-600 font-bold':''}`}>{r.rawInput}{r.type==='HK'&&<span className="text-red-500 ml-1 text-[10px] bg-red-50 px-1 rounded">æ¸¯</span>}</span><span className="text-slate-400 shrink-0 font-bold">{r.isError?'(å¼‚å¸¸)':`Â¥${r.totalAmount}`}</span></div>)}</div></div>)}</div></details>)}</div>}
                        {activeTab === 'risk' && <div className="h-full flex flex-col overflow-hidden"><div className="flex justify-between mb-2 shrink-0"><div className="flex bg-white rounded-lg border p-1 text-xs font-bold shadow-sm"><button onClick={()=>setRiskFilter('MO')} className={`px-3 py-1.5 rounded-md transition-all ${riskFilter==='MO'?'bg-green-500 text-white shadow-sm':'text-slate-500'}`}>æ¾³</button><button onClick={()=>setRiskFilter('HK')} className={`px-3 py-1.5 rounded-md transition-all ${riskFilter==='HK'?'bg-red-500 text-white shadow-sm':'text-slate-500'}`}>æ¸¯</button><button onClick={()=>setRiskFilter('ALL')} className={`px-3 py-1.5 rounded-md transition-all ${riskFilter==='ALL'?'bg-indigo-500 text-white shadow-sm':'text-slate-500'}`}>å…¨</button></div><button onClick={()=>setShowHedgingModal(true)} className="bg-orange-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 shadow-md shadow-orange-200 btn-press"><Icon name="Scale" className="w-4 h-4"/> æ™ºèƒ½åƒç </button></div><div className="flex-1 overflow-y-auto grid grid-cols-2 gap-3 pb-24">{(riskFilter==='ALL'||riskFilter==='MO')&&<MobileRiskTable title="ğŸ‡²ğŸ‡´ æ¾³é—¨" color="green" data={riskStats.mo} total={riskStats.moPool} />}{(riskFilter==='ALL'||riskFilter==='HK')&&<MobileRiskTable title="ğŸ‡­ğŸ‡° é¦™æ¸¯" color="red" data={riskStats.hk} total={riskStats.hkPool} />}</div></div>}
                        {activeTab === 'reconciliation' && <div className="space-y-4"><div className="bg-white p-4 rounded-xl shadow-sm border border-indigo-50 sticky top-[72px] z-40 grid grid-cols-2 gap-4"><div><div className="text-xs text-green-600 font-bold text-center mb-1">ğŸ‡²ğŸ‡´ æ¾³å½©å¼€å¥–</div><input type="number" placeholder="è¾“å…¥" value={winningNumberMO} onChange={e=>setWinningNumberMO(e.target.value)} className="w-full text-center text-2xl font-bold border-2 border-green-100 rounded-xl py-2 text-green-600 focus:border-green-300 outline-none bg-green-50/30"/></div><div><div className="text-xs text-red-600 font-bold text-center mb-1">ğŸ‡­ğŸ‡° æ¸¯å½©å¼€å¥–</div><input type="number" placeholder="è¾“å…¥" value={winningNumberHK} onChange={e=>setWinningNumberHK(e.target.value)} className="w-full text-center text-2xl font-bold border-2 border-red-100 rounded-xl py-2 text-red-600 focus:border-red-300 outline-none bg-red-50/30"/></div></div><div className="space-y-3">{reconciliationStats.map(s => <div key={s.name} className="bg-white rounded-xl border border-slate-200 shadow-sm p-3 group" onClick={()=>setExpandedReconciliation(expandedReconciliation===s.name?null:s.name)}><div className="flex justify-between items-center border-b border-slate-100 pb-2 mb-2"><div className="font-bold text-lg text-slate-800">{s.name}</div><div className={`font-bold text-xl ${s.profit>=0?'text-red-600':'text-green-600'}`}>{s.profit>=0?'+':''}{s.profit.toFixed(0)}</div></div><div className="grid grid-cols-3 gap-2 text-xs text-center mb-2"><div className="bg-slate-50 p-1.5 rounded-lg font-bold text-slate-600">æµæ°´: {s.totalStake}</div><div className="bg-indigo-50 p-1.5 rounded-lg text-indigo-600 font-bold border border-indigo-100">ä¸­: {s.winningStakeTotal}</div><div className="bg-slate-50 p-1.5 rounded-lg text-slate-500">é€€: {s.rebateAmt.toFixed(0)}</div></div>{expandedReconciliation===s.name && <div className="bg-slate-50 p-3 rounded-xl text-xs font-mono mt-2 space-y-2 border border-slate-100 animate-fade-in"><div className="flex flex-col gap-3">{s.batchDetails.map(b => {const winTot = b.winHK+b.winMO; let winLbl = ''; if(winTot>0) { if(b.winHK>0 && b.winMO>0) winLbl=`[ä¸­: Â¥${winTot} (æ¸¯${b.winHK}+é—¨${b.winMO})]`; else if(b.winHK>0) winLbl=`[ä¸­: Â¥${winTot} (æ¸¯)]`; else winLbl=`[ä¸­: Â¥${winTot}]`; } return (<div key={b.idx} className="flex justify-between items-start border-b border-slate-200 last:border-0 pb-1" onClick={(e)=>{e.stopPropagation();setViewingRawBatch(b)}}><span className="font-bold text-slate-600">({b.idx}) åˆè®¡: {b.total}</span>{winTot>0 && <span className="text-red-600 font-bold bg-red-50 px-1 rounded">{winLbl}</span>}</div>);})}</div><button onClick={(e)=>{e.stopPropagation(); copyRec(s);}} className="w-full mt-2 bg-indigo-600 text-white py-2.5 rounded-lg font-bold shadow-md shadow-indigo-200 btn-press flex items-center justify-center gap-1"><Icon name="Copy" className="w-4 h-4"/> å¤åˆ¶å®Œæ•´å¯¹è´¦å•</button></div>}</div>)}</div></div>}
                    </div>

                    {/* Modals */}
                    {batchToEdit && <EditOrderModal batchId={batchToEdit} onClose={()=>setBatchToEdit(null)} onSave={handleSaveEditedBatch} bets={bets} currentYearZodiac={currentYearZodiac} />}
                    {viewingRawBatch && <RawRecordModal batch={viewingRawBatch} onClose={()=>setViewingRawBatch(null)} />}
                    {showHedgingModal && <HedgingModal onClose={()=>setShowHedgingModal(false)} riskStats={riskStats} riskFilter={riskFilter} customers={customers} bets={bets} showAlert={showAlert} />}
                    <ConfirmationModal confirmation={confirmation} />
                    {showCustomerModal && <CustomerSelectModal customers={customers} onSelect={n=>{setInputCustomer(n);setShowCustomerModal(false);showAlert(`å·²åˆ‡æ¢: ${n}`, 'success')}} onClose={()=>setShowCustomerModal(false)} />}
                    {actionSheet && <ActionSheet title={actionSheet.title} actions={actionSheet.actions} onCancel={actionSheet.onCancel} />}
                    {showSettings && <div id="app-modal" className="flex items-center justify-center p-4 animate-fade-in"><div className="bg-white w-full max-w-lg rounded-xl p-4 max-h-[80vh] overflow-y-auto"><div className="flex justify-between items-center mb-4 pb-2 border-b"><h3 className="font-bold text-lg">å®¢æˆ·ç®¡ç†</h3><button onClick={()=>setShowSettings(false)} className="btn-press"><Icon name="X" className="w-6 h-6 text-slate-500"/></button></div><div className="space-y-2">{tempCustomers.map(c=><div key={c.id} className="flex gap-2 items-center"><input value={c.name} onChange={e=>setTempCustomers(p=>p.map(x=>x.id===c.id?{...x,name:e.target.value}:x))} className="border p-2 rounded w-24 text-sm" placeholder="å§“å"/><input type="number" value={isNaN(c.odds)?'':c.odds} onChange={e=>setTempCustomers(p=>p.map(x=>x.id===c.id?{...x,odds:parseFloat(e.target.value)||0}:x))} className="border p-2 rounded w-16 text-sm"/><input type="number" value={isNaN(c.rebate)?'':c.rebate*100} onChange={e=>setTempCustomers(p=>p.map(x=>x.id===c.id?{...x,rebate:(parseFloat(e.target.value)||0)/100}:x))} className="border p-2 rounded w-16 text-sm"/><button onClick={()=>setTempCustomers(p=>p.filter(x=>x.id!==c.id))} className="btn-press"><Icon name="Trash2" className="w-5 h-5 text-red-500"/></button></div>)}</div><div className="mt-4 flex gap-2"><button onClick={()=>setTempCustomers(p=>[...p,{id:Math.random().toString(),name:'',customerType:'å®¢æˆ·',odds:47.5,rebate:0.1,aliases:[]}])} className="flex-1 bg-green-500 text-white py-2 rounded font-bold btn-press">æ–°å¢</button><button onClick={()=>{setCustomers(tempCustomers);setShowSettings(false)}} className="flex-1 bg-blue-500 text-white py-2 rounded font-bold btn-press">ä¿å­˜</button></div></div></div>}
                    {textPreview && <div id="app-modal" className="flex items-center justify-center p-4 animate-fade-in"><div className="bg-white w-full max-w-sm rounded-xl p-4 shadow-2xl flex flex-col h-[60vh]"><div className="flex justify-between items-center border-b pb-2 mb-2"><h3 className="font-bold text-lg">{textPreview.title}</h3><button onClick={()=>setTextPreview(null)} className="btn-press"><Icon name="X" className="w-6 h-6 text-slate-500"/></button></div><textarea className="flex-1 w-full p-3 border rounded-lg bg-slate-50 font-mono text-sm resize-none" value={textPreview.content} onChange={e=>setTextPreview({...textPreview,content:e.target.value})}/><div className="flex gap-3 mt-4"><button onClick={()=>setTextPreview(null)} className="flex-1 py-3 border rounded-lg font-bold text-slate-500 btn-press">å…³é—­</button><button onClick={()=>{const el=document.createElement('textarea');el.value=textPreview.content;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);showAlert('å¤åˆ¶æˆåŠŸ','success')}} className="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 btn-press"><Icon name="Copy" className="w-4 h-4"/> å¤åˆ¶</button></div></div></div>}
                    
                    <div id="bottom-nav" className="bg-white border-t grid grid-cols-4 py-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] text-xs pb-safe">
                        <button onClick={()=>setActiveTab('reconciliation')} className={`flex flex-col items-center gap-1 p-2 ${activeTab==='reconciliation'?'text-indigo-600 font-bold scale-105':'text-slate-400'}`}><Icon name="ClipboardCheck" className="w-6 h-6"/>å¯¹è´¦</button>
                        <button onClick={()=>setActiveTab('input')} className={`flex flex-col items-center gap-1 p-2 ${activeTab==='input'?'text-indigo-600 font-bold scale-105':'text-slate-400'}`}><Icon name="Zap" className="w-6 h-6"/>å½•å…¥</button>
                        <button onClick={()=>setActiveTab('customers')} className={`flex flex-col items-center gap-1 p-2 ${activeTab==='customers'?'text-indigo-600 font-bold scale-105':'text-slate-400'}`}><Icon name="BookOpen" className="w-6 h-6"/>è´¦æœ¬</button>
                        <button onClick={()=>setActiveTab('risk')} className={`flex flex-col items-center gap-1 p-2 ${activeTab==='risk'?'text-indigo-600 font-bold scale-105':'text-slate-400'}`}><Icon name="ShieldAlert" className="w-6 h-6"/>é£æ§</button>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
